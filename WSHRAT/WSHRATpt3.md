
## Part 2

Part two can be found here:
https://github.com/VenzoV/MalwareAnalysisReports/blob/main/WSHRAT/WSHRATpt2.md

## C2 commands


From part two we took a look at the malware making contact with the C2 to receive instructions. The response is parsed, and split on the pipe character.
There are many different commands that the malware can run.
This is all done through a switch statement.
Also, worth noting that the the code sends feedback and error messages to the C2 such as failed installations or failed to recover password.


| Commands | Description |
| ------------- | ------------- |
| disconnect  | Calls wscript to quit process  |
| reboot  | calls %comspec% /c shutdown /r /t /0 /f to reboot the host  |
| shutdown  | calls %comspec% /c shutdown /s /t /0 /f to shutdown the host  |
| execute  | calls eval on the second parameter returned from the first post request  |
| install-sdk  | posts "moz-sdk" to C2 with the post() function, fetches "wshsdk.zip" and unzips it to appdata/wshsdk folder  |
| remove-sdk  | removes the "wshsdk.zip" file and folder created  |
| get-pass  | Get password from: IE, Chrome, Mozilla ,foxmail |
| get-pass-offline  | Get password from: IE, Chrome, Mozilla ,foxmail. Fetches binary for mailpass view, nirsoft tool for password recovery for outlook. Binary is hardcoded in base64 within the code itself
| update  | Fetches another script from the C2 and tries to launch it closing the current one.
| uninstall  | Basically removes registry keys for autorun and deletes the script from all drives
| up-n-exec  |  Used to fetch another file from the C2 and runs executes 
| bring-log  |   Exfiltrates to c2 log files generated from other functions. Example: "wshlogs\recovered_password_email.log" file likely created by the binary "mailpass view". Format: appdata+"wshlogs\"+filename. Where filename can be decided by the c2.
| down-n-exec | Seems similar to up-n-exec, but need to check more. URL and name are passed to the function a get request is made to fetch a file and save with the name supplied in the appdata folder and then runs it.
| filemanager | Calls function that takes a URL, the string "fm-plugin.exe". The function is called "servicestarter". A base64 payload is fetched from the C2, and is used in another call payloadlauncher to save it in the registry key. Overall the objective seems to be to launch yet again another harcoded binary.




## Mail Pass View
Below the zipped & base64 encoded binary.


![Figure 21](Images/figure21.png)

Virus Total results:
* https://www.virustotal.com/gui/file/400b411a9bffd687c5e74f51d43b7dc92cdb8d5ca9f674456b75a5d37587d342/detection
* https://www.nirsoft.net/utils/mailpv.html

![Figure 22](Images/figure22.png)


## Payloadlauncher binary
* https://www.virustotal.com/gui/file/d24396bab076f62921a8be8f54e5255a641b646ff47aa72292bcf40d04aec25e

![Figure 23](Images/figure23.png)